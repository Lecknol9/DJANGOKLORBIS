{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cotizaci√≥n {{ cotizacion.numero }} - Sistema de Cotizaciones</title>
  <link rel="stylesheet" href="{% static 'cotizaciones/css/style.css' %}">
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="logo">
      üìä Sistema de Cotizaciones
      <span class="badge">{{ cotizacion.numero }}</span>
    </div>
    <div class="spacer"></div>
    <div class="user-menu">
      <a href="{% url 'cotizaciones:lista' %}">‚Üê Lista</a>
      <a href="{% url 'cotizaciones:dashboard' %}">Dashboard</a>
    </div>
  </div>

  <div class="container">
    <!-- Actions -->
    <div class="actions">
      <div class="actions-left">
        <h1 style="margin: 0; color: var(--azul-700);">
          Cotizaci√≥n {{ cotizacion.numero }}
        </h1>
        <span class="pill {{ cotizacion.estado }}">
          {{ cotizacion.get_estado_display }}
        </span>
      </div>
      <div class="actions-right">
        <a href="{% url 'cotizaciones:editar' cotizacion.pk %}" class="btn">
          ‚úèÔ∏è Editar
        </a>
        <button type="button" class="btn secondary" onclick="window.print()">
          üñ®Ô∏è Imprimir
        </button>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="card">
      <!-- Header de Empresa -->
      <div class="empresa-header">
        <h1>{{ config_empresa.nombre }}</h1>
        <div class="descripcion">{{ config_empresa.descripcion|linebreaks }}</div>
        <div class="contacto">
          {{ config_empresa.direccion }}<br>
          TEL√âFONOS {{ config_empresa.telefono }} / EMAIL {{ config_empresa.email }}
        </div>
      </div>

      <!-- Informaci√≥n de la Cotizaci√≥n -->
      <div class="cotizacion-info">
        <div class="info-cliente">
          <h4>SE√ëOR(ES): {{ cotizacion.cliente.nombre|upper }}</h4>
          {% if cotizacion.cliente.atencion %}
          <div><strong>ATENCI√ìN:</strong> {{ cotizacion.cliente.atencion|upper }}</div>
          {% endif %}
          {% if cotizacion.cliente.rut %}
          <div><strong>RUT:</strong> {{ cotizacion.cliente.rut }}</div>
          {% endif %}
          {% if cotizacion.cliente.direccion %}
          <div><strong>DIRECCI√ìN:</strong> {{ cotizacion.cliente.direccion }}</div>
          {% endif %}
          <div><strong>REFERENCIA:</strong> {{ cotizacion.referencia|upper }}</div>
          <div><strong>LUGAR:</strong> {{ cotizacion.lugar|upper }}</div>
        </div>
        <div class="info-numero">
          <div class="numero-cotizacion">N¬∞ {{ cotizacion.numero }}</div>
          <div style="color: var(--gris-600); margin-top: 8px;">
            {{ cotizacion.fecha_creacion|date:"d/m/Y" }}
          </div>
        </div>
      </div>

      <!-- Descripci√≥n de Trabajos -->
      {% if items_servicio %}
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--azul-700); margin: 0 0 12px; font-size: 1.1rem;">
          üîß DESCRIPCI√ìN DE TRABAJOS, DETALLE Y VALORIZACI√ìN
        </h4>
        
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width: 60%;">DESCRIPCI√ìN DEL TRABAJO</th>
                <th style="width: 15%;">CANTIDAD</th>
                <th style="width: 15%;">PRECIO UNIT.</th>
                <th style="width: 15%;">SUBTOTAL</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items_servicio %}
              <tr>
                <td>
                  <strong>{{ item.servicio.nombre|upper }}</strong>
                  {% if item.descripcion_personalizada %}
                    <div style="margin-top: 4px; line-height: 1.4;">{{ item.descripcion_personalizada|upper }}</div>
                  {% else %}
                    <div style="margin-top: 4px; line-height: 1.4;">{{ item.servicio.descripcion|upper }}</div>
                  {% endif %}
                  
                  {% if item.parametros.all %}
                    <div style="margin-top: 8px; font-size: 0.9em; color: var(--gris-600);">
                      {% for param in item.parametros.all %}
                        <div>‚Ä¢ {{ param.parametro.nombre }}: {{ param.valor }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>{{ item.cantidad }} {{ item.servicio.unidad }}</td>
                <td>${{ item.precio_unitario|floatformat:0 }}</td>
                <td><strong>${{ item.subtotal|floatformat:0 }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Materiales -->
      {% if items_material %}
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--azul-700); margin: 0 0 12px; font-size: 1.1rem;">
          üì¶ MATERIALES
        </h4>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width: 50%;">MATERIAL</th>
                <th style="width: 20%;">CANTIDAD</th>
                <th style="width: 15%;">PRECIO UNIT.</th>
                <th style="width: 15%;">SUBTOTAL</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items_material %}
              <tr>
                <td>
                  <strong>{{ item.material.codigo }} - {{ item.material.nombre|upper }}</strong>
                  {% if item.descripcion_personalizada %}
                    <div style="margin-top: 4px; line-height: 1.4;">{{ item.descripcion_personalizada|upper }}</div>
                  {% elif item.material.descripcion %}
                    <div style="margin-top: 4px; line-height: 1.4;">{{ item.material.descripcion|upper }}</div>
                  {% endif %}
                </td>
                <td>{{ item.cantidad }} {{ item.material.unidad }}</td>
                <td>${{ item.precio_unitario|floatformat:0 }}</td>
                <td><strong>${{ item.subtotal|floatformat:0 }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Mano de Obra -->
      {% if items_mano_obra %}
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--azul-700); margin: 0 0 12px; font-size: 1.1rem;">
          üë∑ MANO DE OBRA
        </h4>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width: 50%;">DESCRIPCI√ìN</th>
                <th style="width: 20%;">HORAS</th>
                <th style="width: 15%;">PRECIO/HORA</th>
                <th style="width: 15%;">SUBTOTAL</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items_mano_obra %}
              <tr>
                <td>{{ item.descripcion|upper }}</td>
                <td>{{ item.horas }}</td>
                <td>${{ item.precio_hora|floatformat:0 }}</td>
                <td><strong>${{ item.subtotal|floatformat:0 }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Totales -->
      <div style="background: var(--azul-100); border: 2px solid var(--azul-300); border-radius: var(--radius); padding: 20px; margin-top: 24px;">
        <h4 style="margin: 0 0 16px; color: var(--azul-700); text-align: center; font-size: 1.2rem;">üí∞ RESUMEN FINANCIERO</h4>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px 20px; align-items: center;">
          {% if cotizacion.subtotal_servicios > 0 %}
          <div style="font-weight: 600;">TOTAL TRABAJOS:</div>
          <div style="text-align: right; font-weight: 600;">${{ cotizacion.subtotal_servicios|floatformat:0 }}</div>
          {% endif %}
          
          {% if cotizacion.subtotal_materiales > 0 %}
          <div style="font-weight: 600;">MATERIALES:</div>
          <div style="text-align: right; font-weight: 600;">${{ cotizacion.subtotal_materiales|floatformat:0 }}</div>
          {% endif %}
          
          {% if cotizacion.subtotal_mano_obra > 0 %}
          <div style="font-weight: 600;">MANO DE OBRA:</div>
          <div style="text-align: right; font-weight: 600;">${{ cotizacion.subtotal_mano_obra|floatformat:0 }}</div>
          {% endif %}
          
          {% if cotizacion.gastos_traslado > 0 %}
          <div style="font-weight: 600;">GASTOS DE TRASLADO:</div>
          <div style="text-align: right; font-weight: 600;">${{ cotizacion.gastos_traslado|floatformat:0 }}</div>
          {% endif %}
          
          <div style="font-weight: 600;">VALOR NETO:</div>
          <div style="text-align: right; font-weight: 600;">${{ cotizacion.valor_neto|floatformat:0 }}</div>
          
          <div style="font-weight: 600;">VALOR IVA (19%):</div>
          <div style="text-align: right; font-weight: 600;">${{ cotizacion.valor_iva|floatformat:0 }}</div>
          
          <div style="grid-column: 1 / -1; border-top: 2px solid var(--azul-600); padding-top: 12px; margin-top: 12px; display: grid; grid-template-columns: 1fr auto; gap: 20px;">
            <div style="font-size: 1.2rem; font-weight: 800; color: var(--azul-700);">VALOR TOTAL:</div>
            <div style="font-size: 1.3rem; font-weight: 800; color: var(--azul-700); text-align: right;">${{ cotizacion.valor_total|floatformat:0 }}</div>
          </div>
        </div>
      </div>

      <!-- Observaciones -->
      {% if cotizacion.observaciones %}
      <div style="margin-top: 24px; padding: 16px; background: var(--gris-100); border-radius: var(--radius);">
        <h4 style="margin: 0 0 8px; color: var(--azul-700);">üìù OBSERVACIONES</h4>
        <div>{{ cotizacion.observaciones|linebreaks }}</div>
      </div>
      {% endif %}

      <!-- Informaci√≥n adicional -->
      <div style="margin-top: 24px; padding: 16px; border-top: 1px solid var(--gris-300); text-align: center; color: var(--gris-600); font-size: 0.9rem;">
        <div><strong>Tipo de Trabajo:</strong> {{ cotizacion.tipo_trabajo.nombre }}</div>
        <div style="margin-top: 8px;"><strong>Fecha de Creaci√≥n:</strong> {{ cotizacion.fecha_creacion|date:"d/m/Y H:i" }}</div>
        {% if cotizacion.fecha_vencimiento %}
        <div><strong>V√°lida hasta:</strong> {{ cotizacion.fecha_vencimiento|date:"d/m/Y" }}</div>
        {% endif %}
        <div style="margin-top: 8px;"><strong>Creada por:</strong> {{ cotizacion.creado_por.get_full_name|default:cotizacion.creado_por.username }}</div>
      </div>
    </div>
  </div>

  <script src="{% static 'cotizaciones/js/main.js' %}"></script>
</body>
</html>