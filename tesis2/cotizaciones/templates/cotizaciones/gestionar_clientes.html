{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestionar Clientes - Sistema de Cotizaciones</title>
  <link rel="stylesheet" href="{% static 'cotizaciones/css/style.css' %}">
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="logo">
      üìä Sistema de Cotizaciones
      <span class="badge">Clientes</span>
    </div>
    <div class="spacer"></div>
    <div class="user-menu">
      <a href="{% url 'cotizaciones:dashboard' %}">‚Üê Dashboard</a>
      <a href="{% url 'home:panel_empleados' %}">Panel Principal</a>
    </div>
  </div>

  <div class="container">
    <!-- Alerts -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Actions -->
    <div class="actions">
      <div class="actions-left">
        <h1 style="margin: 0; color: var(--azul-700);">Gesti√≥n de Clientes</h1>
      </div>
      <div class="actions-right">
        <button type="button" class="btn" onclick="mostrarModal('modal-cliente')">
          ‚ûï Nuevo Cliente
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <form method="get" style="display: contents;">
        <div class="filter-group">
          <label for="busqueda">Buscar Cliente</label>
          <input type="text" id="busqueda" name="busqueda" value="{{ busqueda }}" 
                 placeholder="Nombre, RUT, email...">
        </div>
        
        <div class="filter-group">
          <label>&nbsp;</label>
          <button type="submit" class="btn">üîç Buscar</button>
        </div>
        
        <div class="filter-group">
          <label>&nbsp;</label>
          <a href="{% url 'cotizaciones:gestionar_clientes' %}" class="btn secondary">üóëÔ∏è Limpiar</a>
        </div>
      </form>
    </div>

    <!-- Tabla de Clientes -->
    <div class="table-wrap">
      <table id="tabla-clientes">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Contacto</th>
            <th>RUT</th>
            <th>Tel√©fono</th>
            <th>Email</th>
            <th>Estado</th>
            <th>Fecha Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for cliente in clientes %}
          <tr>
            <td><strong>{{ cliente.nombre }}</strong></td>
            <td>{{ cliente.atencion|default:"-" }}</td>
            <td>{{ cliente.rut|default:"-" }}</td>
            <td>{{ cliente.telefono|default:"-" }}</td>
            <td>{{ cliente.email|default:"-" }}</td>
            <td>
              <span class="pill {% if cliente.activo %}activo{% else %}inactivo{% endif %}">
                {% if cliente.activo %}Activo{% else %}Inactivo{% endif %}
              </span>
            </td>
            <td>{{ cliente.fecha_creacion|date:"d/m/Y" }}</td>
            <td>
              <div style="display: flex; gap: 4px;">
                <button type="button" class="btn small secondary" 
                        onclick="editarCliente({{ cliente.id }})" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button type="button" class="btn small danger" 
                        onclick="eliminarCliente({{ cliente.id }}, '{{ cliente.nombre }}')" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--gris-600);">
              {% if busqueda %}
                No se encontraron clientes que coincidan con "{{ busqueda }}".
              {% else %}
                No hay clientes registrados a√∫n.
              {% endif %}
              <br><br>
              <button type="button" class="btn" onclick="mostrarModal('modal-cliente')">
                Crear Primer Cliente
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    {% if clientes.has_other_pages %}
    <div class="pagination">
      {% if clientes.has_previous %}
        <a href="?page=1{% if busqueda %}&busqueda={{ busqueda }}{% endif %}">&laquo; Primera</a>
        <a href="?page={{ clientes.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}">&lsaquo; Anterior</a>
      {% endif %}
      
      <span class="current">
        P√°gina {{ clientes.number }} de {{ clientes.paginator.num_pages }}
      </span>
      
      {% if clientes.has_next %}
        <a href="?page={{ clientes.next_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}">Siguiente &rsaquo;</a>
        <a href="?page={{ clientes.paginator.num_pages }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}">√öltima &raquo;</a>
      {% endif %}
    </div>
    {% endif %}

    <!-- Estad√≠sticas -->
    <div class="card">
      <h3>üìä Estad√≠sticas de Clientes</h3>
      <div class="cards" style="margin: 0;">
        <div class="card" style="margin: 0;">
          <h4>Total Clientes</h4>
          <div class="kpi">{{ clientes|length }}</div>
          <div class="muted">Registrados</div>
        </div>
        <div class="card" style="margin: 0;">
          <h4>Activos</h4>
          <div class="kpi">{{ clientes_activos|default:0 }}</div>
          <div class="muted">En uso</div>
        </div>
        <div class="card" style="margin: 0;">
          <h4>Este Mes</h4>
          <div class="kpi">{{ clientes_mes|default:0 }}</div>
          <div class="muted">Nuevos</div>
        </div>
        <div class="card" style="margin: 0;">
          <h4>Con Email</h4>
          <div class="kpi">{{ clientes_con_email|default:0 }}</div>
          <div class="muted">Contactables</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cliente -->
  <div id="modal-cliente" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-cliente-titulo">Nuevo Cliente</h3>
        <button type="button" class="close" onclick="cerrarModal('modal-cliente')">&times;</button>
      </div>
      
      <form id="form-cliente">
        {% csrf_token %}
        <input type="hidden" id="cliente-id" value="">
        
        <div class="form-group">
          <label for="cliente-nombre">Nombre del Cliente *</label>
          <input type="text" id="cliente-nombre" required 
                 placeholder="Ej: LOTEO LAUREL, PATRICIO MU√ëOZ">
        </div>
        
        <div class="form-group">
          <label for="cliente-atencion">Persona de Contacto</label>
          <input type="text" id="cliente-atencion" 
                 placeholder="Ej: ALDO MERELLO, SR. LUIS BELTRAN">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="cliente-rut">RUT</label>
            <input type="text" id="cliente-rut" 
                   placeholder="12.345.678-9">
          </div>
          <div class="form-group">
            <label for="cliente-telefono">Tel√©fono</label>
            <input type="text" id="cliente-telefono" 
                   placeholder="+56 9 1234 5678">
          </div>
        </div>
        
        <div class="form-group">
          <label for="cliente-email">Email</label>
          <input type="email" id="cliente-email" 
                 placeholder="cliente@email.com">
        </div>
        
        <div class="form-group">
          <label for="cliente-direccion">Direcci√≥n</label>
          <textarea id="cliente-direccion" rows="3" 
                    placeholder="Direcci√≥n completa del cliente"></textarea>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="cliente-activo" checked> 
            Cliente Activo
          </label>
        </div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn secondary" onclick="cerrarModal('modal-cliente')">
            Cancelar
          </button>
          <button type="submit" class="btn">
            Guardar Cliente
          </button>
        </div>
      </form>
    </div>
  </div>

<script src="{% static 'cotizaciones/js/main.js' %}"></script>
<script>
  // Funciones espec√≠ficas para gesti√≥n de clientes
  async function editarCliente(clienteId) {
    try {
      // Cargar datos del cliente
      const response = await fetch(`/cotizaciones/cliente/${clienteId}/`);
      const result = await response.json();
      
      if (result.success) {
        // Cambiar t√≠tulo del modal
        document.getElementById('modal-cliente-titulo').textContent = 'Editar Cliente';
        document.getElementById('cliente-id').value = clienteId;
        
        // Llenar los campos con los datos existentes
        document.getElementById('cliente-nombre').value = result.cliente.nombre;
        document.getElementById('cliente-atencion').value = result.cliente.atencion;
        document.getElementById('cliente-rut').value = result.cliente.rut;
        document.getElementById('cliente-telefono').value = result.cliente.telefono;
        document.getElementById('cliente-email').value = result.cliente.email;
        document.getElementById('cliente-direccion').value = result.cliente.direccion;
        document.getElementById('cliente-activo').checked = result.cliente.activo;
        
        // Mostrar modal
        mostrarModal('modal-cliente');
      } else {
        alert('Error al cargar los datos del cliente: ' + result.error);
      }
    } catch (error) {
      console.error('Error cargando cliente:', error);
      alert('Error al cargar los datos del cliente');
    }
  }
  
  // Funci√≥n espec√≠fica para cerrar modal de cliente
  function cerrarModalCliente() {
    document.getElementById('modal-cliente-titulo').textContent = 'Nuevo Cliente';
    document.getElementById('cliente-id').value = '';
    document.getElementById('form-cliente').reset();
    document.getElementById('cliente-activo').checked = true;
    
    // Cerrar modal directamente sin llamar a cerrarModal()
    document.getElementById('modal-cliente').classList.remove('show');
  }
  
  // Manejar env√≠o del formulario
  document.getElementById('form-cliente').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
      nombre: document.getElementById('cliente-nombre').value,
      atencion: document.getElementById('cliente-atencion').value,
      rut: document.getElementById('cliente-rut').value,
      telefono: document.getElementById('cliente-telefono').value,
      email: document.getElementById('cliente-email').value,
      direccion: document.getElementById('cliente-direccion').value,
      activo: document.getElementById('cliente-activo').checked
    };
    
    const clienteId = document.getElementById('cliente-id').value;
    const isEditing = clienteId !== '';
    
    try {
      const url = isEditing ? 
        `/cotizaciones/cliente/${clienteId}/editar/` : 
        '/cotizaciones/cliente/crear/';
      
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(result.message);
        cerrarModalCliente();
        location.reload(); // Recargar para mostrar el nuevo cliente
      } else {
        alert('Error: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error guardando cliente:', error);
      alert('Error al guardar el cliente');
    }
  });
  
  // Cambiar el comportamiento del bot√≥n cerrar del modal
  document.querySelector('#modal-cliente .close').onclick = function() {
    cerrarModalCliente();
  };
</script>
</body>
</html>