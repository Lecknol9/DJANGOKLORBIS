{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestionar Materiales - Sistema de Cotizaciones</title>
  <link rel="stylesheet" href="{% static 'cotizaciones/css/style.css' %}">
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="logo">
      üìä Sistema de Cotizaciones
      <span class="badge">Materiales</span>
    </div>
    <div class="spacer"></div>
    <div class="user-menu">
      <a href="{% url 'cotizaciones:dashboard' %}">‚Üê Dashboard</a>
      <a href="{% url 'home:panel_empleados' %}">Panel Principal</a>
    </div>
  </div>

  <div class="container">
    <!-- Alerts -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Actions -->
    <div class="actions">
      <div class="actions-left">
        <h1 style="margin: 0; color: var(--azul-700);">Cat√°logo de Materiales</h1>
      </div>
      <div class="actions-right">
        <button type="button" class="btn" onclick="mostrarModal('modal-material')">
          ‚ûï Nuevo Material
        </button>
        <button type="button" class="btn secondary" onclick="importarMateriales()">
          üì• Importar CSV
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <form method="get" style="display: contents;">
        <div class="filter-group">
          <label for="categoria">Categor√≠a</label>
          <select id="categoria" name="categoria">
            <option value="">Todas las categor√≠as</option>
            {% for categoria in categorias %}
              <option value="{{ categoria }}" 
                      {% if categoria == categoria_filtro %}selected{% endif %}>
                {{ categoria }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="busqueda">Buscar Material</label>
          <input type="text" id="busqueda" name="busqueda" value="{{ busqueda }}" 
                 placeholder="C√≥digo, nombre, descripci√≥n...">
        </div>
        
        <div class="filter-group">
          <label>&nbsp;</label>
          <button type="submit" class="btn">üîç Filtrar</button>
        </div>
        
        <div class="filter-group">
          <label>&nbsp;</label>
          <a href="{% url 'cotizaciones:gestionar_materiales' %}" class="btn secondary">üóëÔ∏è Limpiar</a>
        </div>
      </form>
    </div>

    <!-- Tabla de Materiales -->
    <div class="table-wrap">
      <table id="tabla-materiales">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Material</th>
            <th>Categor√≠a</th>
            <th>Precio Unitario</th>
            <th>Unidad</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for material in materiales %}
          <tr>
            <td><strong>{{ material.codigo }}</strong></td>
            <td>
              <strong>{{ material.nombre }}</strong>
              {% if material.descripcion %}
              <div style="font-size: 0.85rem; color: var(--gris-600); margin-top: 4px;">
                {{ material.descripcion|truncatewords:15 }}
              </div>
              {% endif %}
            </td>
            <td>
              {% if material.categoria %}
                <span class="pill enviada">{{ material.categoria }}</span>
              {% else %}
                <span class="pill borrador">Sin categor√≠a</span>
              {% endif %}
            </td>
            <td><strong>${{ material.precio_unitario|floatformat:0 }}</strong></td>
            <td>{{ material.unidad }}</td>
            <td>
              <span class="pill {% if material.activo %}activo{% else %}inactivo{% endif %}">
                {% if material.activo %}Activo{% else %}Inactivo{% endif %}
              </span>
            </td>
            <td>
              <div style="display: flex; gap: 4px;">
                <button type="button" class="btn small secondary" 
                        onclick="editarMaterial({{ material.id }})" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button type="button" class="btn small danger" 
                        onclick="eliminarMaterial({{ material.id }}, '{{ material.nombre }}')" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--gris-600);">
              {% if categoria_filtro or busqueda %}
                No se encontraron materiales que coincidan con los filtros aplicados.
              {% else %}
                No hay materiales registrados a√∫n.
              {% endif %}
              <br><br>
              <button type="button" class="btn" onclick="mostrarModal('modal-material')">
                Crear Primer Material
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    {% if materiales.has_other_pages %}
    <div class="pagination">
      {% if materiales.has_previous %}
        <a href="?page=1{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">&laquo; Primera</a>
        <a href="?page={{ materiales.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">&lsaquo; Anterior</a>
      {% endif %}
      
      <span class="current">
        P√°gina {{ materiales.number }} de {{ materiales.paginator.num_pages }}
      </span>
      
      {% if materiales.has_next %}
        <a href="?page={{ materiales.next_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">Siguiente &rsaquo;</a>
        <a href="?page={{ materiales.paginator.num_pages }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">√öltima &raquo;</a>
      {% endif %}
    </div>
    {% endif %}

    <!-- Categor√≠as de Materiales -->
    <div class="card">
      <h3>üì¶ Categor√≠as de Materiales</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
        {% for categoria in categorias %}
        <div style="background: var(--azul-100); padding: 12px; border-radius: 8px; border: 1px solid var(--azul-300); text-align: center;">
          <strong style="color: var(--azul-700);">{{ categoria }}</strong>
          <div style="font-size: 0.8rem; color: var(--gris-600); margin-top: 4px;">
            {{ categoria|length }} materiales
          </div>
        </div>
        {% empty %}
        <div style="text-align: center; color: var(--gris-600);">
          Las categor√≠as se crean autom√°ticamente al agregar materiales.
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="card">
      <h3>üìä Estad√≠sticas de Materiales</h3>
      <div class="cards" style="margin: 0;">
        <div class="card" style="margin: 0;">
          <h4>Total Materiales</h4>
          <div class="kpi">{{ materiales|length }}</div>
          <div class="muted">Disponibles</div>
        </div>
        <div class="card" style="margin: 0;">
          <h4>Categor√≠as</h4>
          <div class="kpi">{{ categorias|length }}</div>
          <div class="muted">Organizadas</div>
        </div>
        <div class="card" style="margin: 0;">
          <h4>Activos</h4>
          <div class="kpi">{{ materiales_activos|default:0 }}</div>
          <div class="muted">En uso</div>
        </div>
        <div class="card" style="margin: 0;">
          <h4>Valor Promedio</h4>
          <div class="kpi">${{ precio_promedio|default:0|floatformat:0 }}</div>
          <div class="muted">Por material</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Material -->
  <div id="modal-material" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-material-titulo">Nuevo Material</h3>
        <button type="button" class="close" onclick="cerrarModal('modal-material')">&times;</button>
      </div>
      
      <form id="form-material">
        {% csrf_token %}
        <input type="hidden" id="material-id" value="">
        
        <div class="form-row">
          <div class="form-group">
            <label for="material-codigo">C√≥digo del Material *</label>
            <input type="text" id="material-codigo" required 
                   placeholder="Ej: BOM-001, EST-500L">
          </div>
          <div class="form-group">
            <label for="material-categoria">Categor√≠a</label>
            <input type="text" id="material-categoria" 
                   placeholder="Ej: Bombas, Estanques, El√©ctrico">
          </div>
        </div>
        
        <div class="form-group">
          <label for="material-nombre">Nombre del Material *</label>
          <input type="text" id="material-nombre" required 
                 placeholder="Ej: Bomba Sumergible Franklin 7.5HP">
        </div>
        
        <div class="form-group">
          <label for="material-descripcion">Descripci√≥n</label>
          <textarea id="material-descripcion" rows="3"
                    placeholder="Descripci√≥n detallada del material, especificaciones t√©cnicas..."></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="material-precio">Precio Unitario *</label>
            <input type="number" id="material-precio" step="0.01" min="0" required
                   placeholder="250000">
          </div>
          <div class="form-group">
            <label for="material-unidad">Unidad *</label>
            <input type="text" id="material-unidad" required
                   placeholder="UND, MT, KG, LT, etc.">
          </div>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="material-activo" checked> 
            Material Activo
          </label>
        </div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn secondary" onclick="cerrarModal('modal-material')">
            Cancelar
          </button>
          <button type="submit" class="btn">
            Guardar Material
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Importar CSV -->
  <div id="modal-importar" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Importar Materiales desde CSV</h3>
        <button type="button" class="close" onclick="cerrarModal('modal-importar')">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4 style="color: var(--azul-700);">Formato requerido del CSV:</h4>
        <div style="background: var(--gris-100); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.85rem;">
          codigo,nombre,categoria,precio_unitario,unidad,descripcion<br>
          BOM-001,"Bomba Franklin 7.5HP",Bombas,850000,UND,"Bomba sumergible..."<br>
          EST-500,"Estanque 500L",Estanques,120000,UND,"Estanque de presi√≥n..."
        </div>
      </div>
      
      <form id="form-importar" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
          <label for="archivo-csv">Archivo CSV *</label>
          <input type="file" id="archivo-csv" accept=".csv" required>
          <small style="color: var(--gris-600);">
            Selecciona un archivo CSV con la estructura mostrada arriba.
          </small>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="actualizar-existentes"> 
            Actualizar materiales existentes
          </label>
          <small style="color: var(--gris-600);">
            Si est√° marcado, actualizar√° materiales con c√≥digos existentes.
          </small>
        </div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn secondary" onclick="cerrarModal('modal-importar')">
            Cancelar
          </button>
          <button type="submit" class="btn">
            Importar Materiales
          </button>
        </div>
      </form>
    </div>
  </div>

<script src="{% static 'cotizaciones/js/main.js' %}"></script>
<script>
  // Funciones espec√≠ficas para gesti√≥n de materiales
  async function editarMaterial(materialId) {
    try {
      // Cargar datos del material
      const response = await fetch(`/cotizaciones/material/${materialId}/`);
      const result = await response.json();
      
      if (result.success) {
        // Cambiar t√≠tulo del modal
        document.getElementById('modal-material-titulo').textContent = 'Editar Material';
        document.getElementById('material-id').value = materialId;
        
        // Llenar los campos con los datos existentes
        document.getElementById('material-codigo').value = result.material.codigo;
        document.getElementById('material-nombre').value = result.material.nombre;
        document.getElementById('material-categoria').value = result.material.categoria;
        document.getElementById('material-descripcion').value = result.material.descripcion;
        document.getElementById('material-precio').value = result.material.precio_unitario;
        document.getElementById('material-unidad').value = result.material.unidad;
        document.getElementById('material-activo').checked = result.material.activo;
        
        // Mostrar modal
        mostrarModal('modal-material');
      } else {
        alert('Error al cargar los datos del material: ' + result.error);
      }
    } catch (error) {
      console.error('Error cargando material:', error);
      alert('Error al cargar los datos del material');
    }
  }
  
  function importarMateriales() {
    mostrarModal('modal-importar');
  }
  
  // Funci√≥n espec√≠fica para cerrar modal de material
  function cerrarModalMaterial() {
    document.getElementById('modal-material-titulo').textContent = 'Nuevo Material';
    document.getElementById('material-id').value = '';
    document.getElementById('form-material').reset();
    document.getElementById('material-activo').checked = true;
    
    // Cerrar modal directamente
    document.getElementById('modal-material').classList.remove('show');
  }
  
  // Manejar env√≠o del formulario de materiales
  document.getElementById('form-material').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
      codigo: document.getElementById('material-codigo').value,
      nombre: document.getElementById('material-nombre').value,
      categoria: document.getElementById('material-categoria').value,
      descripcion: document.getElementById('material-descripcion').value,
      precio_unitario: document.getElementById('material-precio').value,
      unidad: document.getElementById('material-unidad').value,
      activo: document.getElementById('material-activo').checked
    };
    
    const materialId = document.getElementById('material-id').value;
    const isEditing = materialId !== '';
    
    try {
      const url = isEditing ? 
        `/cotizaciones/material/${materialId}/editar/` : 
        '/cotizaciones/material/crear/';
      
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(result.message);
        cerrarModalMaterial();
        location.reload();
      } else {
        alert('Error: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error guardando material:', error);
      alert('Error al guardar el material');
    }
  });
  
  // Manejar importaci√≥n de CSV
  document.getElementById('form-importar').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const archivo = document.getElementById('archivo-csv').files[0];
    const actualizar = document.getElementById('actualizar-existentes').checked;
    
    if (!archivo) {
      alert('Por favor selecciona un archivo CSV');
      return;
    }
    
    const formData = new FormData();
    formData.append('archivo', archivo);
    formData.append('actualizar_existentes', actualizar);
    
    try {
      const response = await fetch('/cotizaciones/material/importar/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken()
        },
        body: formData
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(`Importaci√≥n completada: ${result.materiales_creados} materiales procesados`);
        cerrarModal('modal-importar');
        location.reload();
      } else {
        alert('Error en importaci√≥n: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error importando archivo:', error);
      alert('Error al importar el archivo');
    }
  });
  
  // Validar c√≥digo √∫nico al escribir
  document.getElementById('material-codigo').addEventListener('blur', async function() {
    const codigo = this.value.trim();
    const materialId = document.getElementById('material-id').value;
    
    if (codigo && !materialId) { // Solo validar para nuevos materiales
      try {
        const response = await fetch(`/cotizaciones/material/validar-codigo/?codigo=${encodeURIComponent(codigo)}`);
        const result = await response.json();
        
        if (!result.disponible) {
          alert('Este c√≥digo ya est√° en uso. Por favor elige otro.');
          this.focus();
        }
      } catch (error) {
        console.error('Error validando c√≥digo:', error);
      }
    }
  });
  
  // Cambiar el comportamiento del bot√≥n cerrar del modal
  document.querySelector('#modal-material .close').onclick = function() {
    cerrarModalMaterial();
  };
</script>
</body>
</html>